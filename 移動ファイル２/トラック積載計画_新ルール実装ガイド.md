# ãƒˆãƒ©ãƒƒã‚¯ç©è¼‰è¨ˆç”» - æ–°ãƒ«ãƒ¼ãƒ«å®Ÿè£…ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ å®Ÿè£…æ¦‚è¦

`domain/calculators/transport_planner.py` ã‚’æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦å®Œå…¨ã«å†è¨­è¨ˆã—ã¾ã—ãŸã€‚

---

## ğŸ¯ æ–°ãƒ«ãƒ¼ãƒ«ã®è©³ç´°

### **åŸºæœ¬è¨­å®š**

1. **åº•é¢ç©ãƒ™ãƒ¼ã‚¹ã®è¨ˆç®—**
   - å¾“æ¥ã®ä½“ç©è¨ˆç®—ã§ã¯ãªãã€å®¹å™¨ã¨ãƒˆãƒ©ãƒƒã‚¯ã®åº•é¢ç©ï¼ˆå¹…Ã—å¥¥è¡Œï¼‰ã§è¨ˆç®—
   - é«˜ã•ã¯è€ƒæ…®ã—ãªã„ï¼ˆç©ã¿é‡ã­ã¯åˆ¥é€”ç®¡ç†ï¼‰
   - **æ®µç©ã¿å¯¾å¿œ**: åŒã˜å®¹å™¨ã¯æ®µç©ã¿å¯èƒ½ï¼ˆ`max_stack`ã§æŒ‡å®šï¼‰

2. **ãƒˆãƒ©ãƒƒã‚¯æ§‹æˆ**
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3å°: é€šå¸¸ä½¿ç”¨ã™ã‚‹ãƒˆãƒ©ãƒƒã‚¯
   - éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1å°: éœ€è¦ãŒå¤šã„å ´åˆã®ã¿ä½¿ç”¨

3. **å‰å€’ã—åˆ¶é™**
   - å‰å€’ã—ã¯1æ—¥å‰ã®ã¿å¯èƒ½
   - ä¾‹: 10/10åˆ† â†’ 10/9å¯ã€10/8ä¸å¯

4. **å„ªå…ˆç©è¼‰è£½å“**
   - ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¹ã‚¿ã« `priority_product_codes` ã‚«ãƒ©ãƒ ã‚’ä½¿ç”¨
   - ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è£½å“ã‚³ãƒ¼ãƒ‰ã‚’æŒ‡å®šï¼ˆä¾‹: "P001,P002"ï¼‰

---

## ğŸ“¦ æ®µç©ã¿è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

### **æ®µç©ã¿å¯èƒ½æ¡ä»¶**
- å®¹å™¨ãƒã‚¹ã‚¿ã® `stackable` ãŒ `True`
- å®¹å™¨ãƒã‚¹ã‚¿ã® `max_stack` ãŒ 2 ä»¥ä¸Š

### **åº•é¢ç©è¨ˆç®—å¼**

#### **æ®µç©ã¿ãªã—ã®å ´åˆ**
```
åº•é¢ç© = å®¹å™¨ã®åº•é¢ç© Ã— å®¹å™¨æ•°
```

#### **æ®µç©ã¿ã‚ã‚Šã®å ´åˆ**
```
å®Ÿéš›ã®å®¹å™¨é…ç½®æ•° = âŒˆå®¹å™¨æ•° Ã· max_stackâŒ‰
åº•é¢ç© = å®¹å™¨ã®åº•é¢ç© Ã— å®Ÿéš›ã®å®¹å™¨é…ç½®æ•°
```

### **è¨ˆç®—ä¾‹**

**ä¾‹1: æ®µç©ã¿2æ®µã®å ´åˆ**
```
è£½å“: P001
å®¹å™¨: F_K (1760mm Ã— 1150mm, max_stack=2)
æ•°é‡: 56å€‹
capacity: 8å€‹/å®¹å™¨

å®¹å™¨æ•° = âŒˆ56 Ã· 8âŒ‰ = 7å®¹å™¨
å®Ÿéš›ã®é…ç½®æ•° = âŒˆ7 Ã· 2âŒ‰ = 4é…ç½®ï¼ˆ2æ®µÃ—3 + 1æ®µÃ—1ï¼‰
åº•é¢ç© = 1760 Ã— 1150 Ã— 4 = 8,096,000 mmÂ²
```

**ä¾‹2: æ®µç©ã¿ãªã—ã®å ´åˆ**
```
è£½å“: P002
å®¹å™¨: R_B (1030mm Ã— 830mm, max_stack=1)
æ•°é‡: 24å€‹
capacity: 6å€‹/å®¹å™¨

å®¹å™¨æ•° = âŒˆ24 Ã· 6âŒ‰ = 4å®¹å™¨
å®Ÿéš›ã®é…ç½®æ•° = 4é…ç½®ï¼ˆæ®µç©ã¿ãªã—ï¼‰
åº•é¢ç© = 1030 Ã— 830 Ã— 4 = 3,419,200 mmÂ²
```

---

## ğŸ”„ è¨ˆç”»ä½œæˆãƒ—ãƒ­ã‚»ã‚¹

### **Step1: éœ€è¦åˆ†æã¨ãƒˆãƒ©ãƒƒã‚¯å°æ•°æ±ºå®š**

```python
def _analyze_demand_and_decide_trucks(...)
```

**å‡¦ç†å†…å®¹:**
1. å…¨å—æ³¨ã®åº•é¢ç©ã‚’è¨ˆç®—
2. æ—¥å¹³å‡ç©è¼‰é‡ã‚’ç®—å‡º
3. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ3å°ã®ç·åº•é¢ç©ã¨æ¯”è¼ƒ
4. å¹³å‡é‡ãŒè¶…éã™ã‚‹å ´åˆã€éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ã‚’ä½¿ç”¨

**åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯:**
```python
avg_floor_area = total_floor_area / len(working_dates)
use_non_default = avg_floor_area > default_total_floor_area
```

---

### **Step2: å‰å€’ã—å‡¦ç†ï¼ˆæœ€çµ‚æ—¥ã‹ã‚‰é€†é †ï¼‰**

```python
def _forward_scheduling(...)
```

**å‡¦ç†å†…å®¹:**
1. æœ€çµ‚æ—¥ã‹ã‚‰é †ã«å„æ—¥ã®ç©è¼‰é‡ã‚’ãƒã‚§ãƒƒã‚¯
2. ãƒˆãƒ©ãƒƒã‚¯èƒ½åŠ›ã‚’è¶…éã™ã‚‹å ´åˆã€è¶…éåˆ†ã‚’å‰æ—¥ã«å‰å€’ã—
3. å‰å€’ã—åˆ†ã¯å‰æ—¥ã®ç©è¼‰å¯¾è±¡ã«è¿½åŠ 

**é‡è¦ãƒã‚¤ãƒ³ãƒˆ:**
- æœ€çµ‚æ—¥ã‹ã‚‰é€†é †ã«å‡¦ç†ã™ã‚‹ã“ã¨ã§ã€å‰å€’ã—ã®é€£é–ã‚’é˜²æ­¢
- 1æ—¥å‰ã®ã¿å‰å€’ã—å¯èƒ½ï¼ˆ2æ—¥ä»¥ä¸Šå‰ã«ã¯ç§»å‹•ã—ãªã„ï¼‰

**ä¾‹:**
```
å…ƒã®è¨ˆç”»:
  10/10: åº•é¢ç© 150ã¡ï¼ˆè¶…é50ã¡ï¼‰
  10/09: åº•é¢ç© 80ã¡

å‰å€’ã—å¾Œ:
  10/10: åº•é¢ç© 100ã¡
  10/09: åº•é¢ç© 130ã¡ï¼ˆ50ã¡è¿½åŠ ï¼‰
```

---

### **Step3: æ—¥æ¬¡ç©è¼‰è¨ˆç”»ä½œæˆ**

```python
def _create_daily_loading_plan(...)
```

**ç©è¼‰å„ªå…ˆé †ä½:**

#### **3-1. å„ªå…ˆç©è¼‰è£½å“**
```python
def _load_priority_products(...)
```
- ãƒˆãƒ©ãƒƒã‚¯ã® `priority_product_codes` ã«æŒ‡å®šã•ã‚ŒãŸè£½å“ã‚’å„ªå…ˆçš„ã«ç©è¼‰
- ä¾‹: ãƒˆãƒ©ãƒƒã‚¯NO_4_10T ã®å„ªå…ˆè£½å“ãŒ "P001" ã®å ´åˆã€P001ã‚’æœ€å„ªå…ˆ

#### **3-2. åŒå®¹å™¨ã®è£½å“**
```python
def _load_same_container_products(...)
```
- æ—¢ã«ç©è¼‰ã—ãŸè£½å“ã¨åŒã˜å®¹å™¨ã‚’ä½¿ç”¨ã™ã‚‹è£½å“ã‚’ç©è¼‰
- è£½å“ã®åˆ†æ•£ã‚’é˜²æ­¢ã—ã€ç©è¼‰åŠ¹ç‡ã‚’å‘ä¸Š

**ä¾‹:**
```
ãƒˆãƒ©ãƒƒã‚¯NO_4_10T:
- å„ªå…ˆè£½å“: P001ï¼ˆF_Kå®¹å™¨ï¼‰18å° â† å„ªå…ˆç©è¼‰
- æ®‹ã‚Šç©ºé–“: F_Kå®¹å™¨Ã—2å°åˆ†
- å€™è£œ:
  - P002ï¼ˆF_Kå®¹å™¨ï¼‰2å° â† åŒå®¹å™¨ãªã®ã§é¸æŠ
  - P003ï¼ˆF_Kå®¹å™¨ï¼‰10å°
  - P004ï¼ˆG_Lå®¹å™¨ï¼‰5å°
â†’ P002ã‚’ç©è¼‰
```

#### **3-3. ç•°å®¹å™¨ã®è£½å“**
```python
def _load_other_products(...)
```
- ä½™è£•ãŒã‚ã‚Œã°ç•°ãªã‚‹å®¹å™¨ã®è£½å“ã‚‚ç©è¼‰

---

### **Step4: éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯æ´»ç”¨**

**æ¡ä»¶:**
- Step1ã§ `use_non_default = True` ã¨åˆ¤å®šã•ã‚ŒãŸå ´åˆã®ã¿
- éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ã® `arrival_day_offset` ã¯é€šå¸¸1æ—¥

**å‹•ä½œ:**
```python
if use_non_default:
    available_trucks = [(tid, t) for tid, t in truck_map.items()]
else:
    available_trucks = [(tid, t) for tid, t in truck_map.items() 
                       if t.get('default_use', False)]
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

### **å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**

#### **ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¹ã‚¿ (truck_master)**
```sql
CREATE TABLE truck_master (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    width INTEGER,           -- mm
    depth INTEGER,           -- mm
    height INTEGER,          -- mm
    default_use BOOLEAN,     -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨ãƒ•ãƒ©ã‚°
    arrival_day_offset INTEGER,  -- åˆ°ç€æ—¥ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    priority_product_codes VARCHAR(255)  -- å„ªå…ˆç©è¼‰è£½å“ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
);
```

**ä¾‹:**
```csv
id,name,width,depth,height,default_use,arrival_day_offset,priority_product_codes
1,ãƒˆãƒ©ãƒƒã‚¯NO_4_10T,2200,4500,2500,TRUE,0,"P001,P002"
2,ãƒˆãƒ©ãƒƒã‚¯NO_5_10T,2200,4500,2500,TRUE,0,"P003"
3,ãƒˆãƒ©ãƒƒã‚¯NO_6_10T,2200,4500,2500,TRUE,0,""
4,ãƒˆãƒ©ãƒƒã‚¯NO_7_4T,1800,3500,2000,FALSE,1,""
```

#### **å®¹å™¨ãƒã‚¹ã‚¿ (container_capacity)**
```sql
CREATE TABLE container_capacity (
    id INTEGER PRIMARY KEY,
    name VARCHAR(50),
    width INTEGER,   -- mm
    depth INTEGER,   -- mm
    height INTEGER   -- mm
);
```

---

### **å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**

#### **æ—¥æ¬¡ç©è¼‰è¨ˆç”»**
```python
{
    'daily_plans': {
        '2025-10-10': {
            'trucks': [
                {
                    'truck_id': 1,
                    'truck_name': 'ãƒˆãƒ©ãƒƒã‚¯NO_4_10T',
                    'loaded_items': [
                        {
                            'product_code': 'P001',
                            'num_containers': 18,
                            'floor_area': 18000000,  # mmÂ²
                            'floor_area_per_container': 1000000
                        }
                    ],
                    'utilization': {
                        'floor_area_rate': 95.5,
                        'volume_rate': 95.5,
                        'weight_rate': 0
                    }
                }
            ],
            'total_trips': 1,
            'warnings': []
        }
    },
    'summary': {
        'total_days': 7,
        'total_trips': 15,
        'total_warnings': 0,
        'use_non_default_truck': False,
        'status': 'æ­£å¸¸'
    }
}
```

---

## ğŸ”§ è¨­å®šæ–¹æ³•

### **1. ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¹ã‚¿ã®è¨­å®š**

#### **å„ªå…ˆç©è¼‰è£½å“ã®è¨­å®š**
```sql
UPDATE truck_master 
SET priority_product_codes = 'P001,P002,P003'
WHERE id = 1;
```

#### **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½¿ç”¨ãƒ•ãƒ©ã‚°ã®è¨­å®š**
```sql
-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ï¼ˆ3å°ï¼‰
UPDATE truck_master SET default_use = TRUE WHERE id IN (1, 2, 3);

-- éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ï¼ˆ1å°ï¼‰
UPDATE truck_master SET default_use = FALSE WHERE id = 4;
```

---

### **2. è£½å“ãƒã‚¹ã‚¿ã®è¨­å®š**

#### **ä½¿ç”¨ãƒˆãƒ©ãƒƒã‚¯ã®è¨­å®š**
```sql
UPDATE products 
SET used_truck_ids = '1,2,3'  -- å„ªå…ˆé †ä½ä»˜ã
WHERE product_code = 'P001';
```

---

## ğŸ“ˆ è¨ˆç®—ä¾‹

### **ã‚·ãƒŠãƒªã‚ª**
- è¨ˆç”»æœŸé–“: 10/10 ~ 10/16 (7å–¶æ¥­æ—¥)
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯3å°: å„10ã¡ = åˆè¨ˆ30ã¡
- ç·éœ€è¦: 200ã¡
- æ—¥å¹³å‡: 200ã¡ Ã· 7æ—¥ = 28.6ã¡

### **Step1: éœ€è¦åˆ†æ**
```
æ—¥å¹³å‡ 28.6ã¡ < ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒ½åŠ› 30ã¡
â†’ use_non_default = Falseï¼ˆéãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ä¸ä½¿ç”¨ï¼‰
```

### **Step2: å‰å€’ã—å‡¦ç†**
```
10/16: 35ã¡ï¼ˆè¶…é5ã¡ï¼‰ â†’ 10/15ã«5ã¡å‰å€’ã—
10/15: 30ã¡ â†’ OK
10/14: 28ã¡ â†’ OK
...
```

### **Step3: æ—¥æ¬¡ç©è¼‰è¨ˆç”»**
```
10/10:
  ãƒˆãƒ©ãƒƒã‚¯1: å„ªå…ˆè£½å“P001ï¼ˆ8ã¡ï¼‰+ åŒå®¹å™¨P002ï¼ˆ2ã¡ï¼‰= 10ã¡
  ãƒˆãƒ©ãƒƒã‚¯2: å„ªå…ˆè£½å“P003ï¼ˆ9ã¡ï¼‰= 9ã¡
  ãƒˆãƒ©ãƒƒã‚¯3: è£½å“P004ï¼ˆ9ã¡ï¼‰= 9ã¡
  åˆè¨ˆ: 28ã¡
```

---

## âš ï¸ æ³¨æ„äº‹é …

### **1. åº•é¢ç©ã®å˜ä½**
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ mm å˜ä½
- è¨ˆç®—æ™‚ã¯ mmÂ² ã§å‡¦ç†
- è¡¨ç¤ºæ™‚ã¯ ã¡ ã«å¤‰æ›ï¼ˆÃ· 1,000,000ï¼‰

### **2. 1æ—¥1ä¾¿åˆ¶ç´„**
- å„ãƒˆãƒ©ãƒƒã‚¯ã¯1æ—¥ã«1å›ã®ã¿ä½¿ç”¨
- åŒã˜ãƒˆãƒ©ãƒƒã‚¯ãŒåŒã˜æ—¥ã«è¤‡æ•°å›å‡ºç¾ã—ãªã„

### **3. å‰å€’ã—ã®åˆ¶é™**
- 1æ—¥å‰ã®ã¿å‰å€’ã—å¯èƒ½
- è£½å“ã® `can_advance` ãƒ•ãƒ©ã‚°ã¯ç¾åœ¨æœªä½¿ç”¨ï¼ˆå°†æ¥æ‹¡å¼µç”¨ï¼‰

### **4. å„ªå…ˆç©è¼‰è£½å“**
- ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°æŒ‡å®šå¯èƒ½
- è£½å“ã‚³ãƒ¼ãƒ‰ã¯å®Œå…¨ä¸€è‡´ã§åˆ¤å®š
- ç©ºç™½ã¯è‡ªå‹•çš„ã«ãƒˆãƒªãƒ ã•ã‚Œã‚‹

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæ–¹æ³•

### **1. åŸºæœ¬å‹•ä½œç¢ºèª**
```python
# ã‚¢ãƒ—ãƒªã‚’èµ·å‹•
streamlit run main.py

# é…é€ä¾¿è¨ˆç”»ãƒšãƒ¼ã‚¸ã§è¨ˆç”»ä½œæˆ
# - æœŸé–“é¸æŠ
# - è¨ˆç”»ä½œæˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
# - çµæœç¢ºèª
```

### **2. éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ä½¿ç”¨ç¢ºèª**
```python
# å¤§é‡ã®å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
# â†’ æ—¥å¹³å‡ãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒ½åŠ›ã‚’è¶…ãˆã‚‹
# â†’ éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯ãŒä½¿ç”¨ã•ã‚Œã‚‹
```

### **3. å„ªå…ˆç©è¼‰è£½å“ç¢ºèª**
```python
# ãƒˆãƒ©ãƒƒã‚¯ãƒã‚¹ã‚¿ã§ priority_product_codes ã‚’è¨­å®š
# â†’ è©²å½“è£½å“ãŒå„ªå…ˆçš„ã«ç©è¼‰ã•ã‚Œã‚‹
```

---

## ğŸ“ ä»Šå¾Œã®æ‹¡å¼µ

### **1. è£½å“åˆ†å‰²ã®æœ€é©åŒ–**
- ç¾åœ¨: 1è£½å“ã¯1ãƒˆãƒ©ãƒƒã‚¯ã«ç©è¼‰
- æ”¹å–„æ¡ˆ: å¤§é‡ã®è£½å“ã‚’è¤‡æ•°ãƒˆãƒ©ãƒƒã‚¯ã«åˆ†å‰²

### **2. é‡é‡åˆ¶ç´„ã®è¿½åŠ **
- ç¾åœ¨: åº•é¢ç©ã®ã¿è€ƒæ…®
- æ”¹å–„æ¡ˆ: é‡é‡åˆ¶ç´„ã‚‚è¿½åŠ 

### **3. å‹•çš„ãªå‰å€’ã—æ—¥æ•°**
- ç¾åœ¨: 1æ—¥å‰ã®ã¿
- æ”¹å–„æ¡ˆ: è£½å“ã® `can_advance` ãƒ•ãƒ©ã‚°ã§åˆ¶å¾¡

---

## âœ… å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] åº•é¢ç©ãƒ™ãƒ¼ã‚¹ã®è¨ˆç®—å®Ÿè£…
- [x] **æ®µç©ã¿å¯¾å¿œï¼ˆåŒã˜å®¹å™¨ã®æ®µç©ã¿è¨ˆç®—ï¼‰**
- [x] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ/éãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒˆãƒ©ãƒƒã‚¯åˆ¤å®š
- [x] å‰å€’ã—å‡¦ç†ï¼ˆæœ€çµ‚æ—¥ã‹ã‚‰é€†é †ï¼‰
- [x] å„ªå…ˆç©è¼‰è£½å“ã®å®Ÿè£…
- [x] åŒå®¹å™¨è£½å“ã®å„ªå…ˆç©è¼‰
- [x] 1æ—¥1ä¾¿åˆ¶ç´„ã®ç¶­æŒ
- [x] äº’æ›æ€§ã®ç¢ºä¿ï¼ˆæ—¢å­˜ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç¶­æŒï¼‰

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**: `domain/calculators/transport_planner.py`
- **ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«**: `domain/models/transport.py`
- **ã‚µãƒ¼ãƒ“ã‚¹å±¤**: `services/transport_service.py`
- **UI**: `ui/pages/transport_plan_page.py`

---

**å®Ÿè£…æ—¥**: 2025-10-10  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0
